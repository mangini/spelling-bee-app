<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spelling Quest</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;600;700&family=Fredoka:wght@500;600&display=swap');

    :root {
      --bg-1: #fff4d8;
      --bg-2: #ffe1ec;
      --bg-3: #d8f3ff;
      --card: #fffdf7;
      --accent: #ff7ac3;
      --accent-2: #ffb347;
      --accent-3: #5cc6ff;
      --accent-4: #66e3b0;
      --text: #2b243f;
      --muted: #5d5771;
      --success: #28c57b;
      --danger: #ff5252;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Baloo 2", "Fredoka", "Comic Neue", "Avenir Next", sans-serif;
      background:
        radial-gradient(circle at 12% 18%, rgba(255, 179, 71, 0.36), transparent 30%),
        radial-gradient(circle at 82% 12%, rgba(92, 198, 255, 0.28), transparent 32%),
        radial-gradient(circle at 24% 72%, rgba(255, 122, 195, 0.28), transparent 26%),
        radial-gradient(circle at 90% 72%, rgba(102, 227, 176, 0.28), transparent 28%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2), var(--bg-3));
      color: var(--text);
      position: relative;
      overflow-x: hidden;
    }

    body::before,
    body::after {
      content: "";
      position: fixed;
      width: 320px;
      height: 320px;
      border-radius: 40% 60% 50% 70%;
      filter: blur(70px);
      opacity: 0.35;
      pointer-events: none;
      z-index: 0;
    }

    body::before {
      background: var(--accent-3);
      top: -120px;
      left: -160px;
    }

    body::after {
      background: var(--accent);
      bottom: -140px;
      right: -140px;
    }

    .app {
      position: relative;
      z-index: 1;
      max-width: 1100px;
      margin: 0 auto;
      padding: 36px 22px 90px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 18px;
      background: rgba(255, 255, 255, 0.65);
      border: 2px solid #ffd68a;
      border-radius: 20px;
      padding: 12px 14px;
      box-shadow: 0 15px 40px rgba(255, 122, 195, 0.12);
      backdrop-filter: blur(6px);
    }

    h1 {
      margin: 0;
      font-size: 34px;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: #ff5c99;
      text-shadow: 0 3px 0 #ffe6f4;
    }

    h1 span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, #fff6d0, #ffb347);
      color: #3a2a00;
      font-weight: 800;
      font-size: 22px;
      box-shadow: 0 10px 25px rgba(255, 179, 71, 0.35);
      border: 2px solid #ffe6b8;
    }

    .meta {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 15px;
      color: var(--muted);
    }

    .pill {
      padding: 11px 14px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(255, 186, 92, 0.18), rgba(92, 198, 255, 0.18));
      color: #2b243f;
      font-weight: 800;
      border: 2px solid #ffe0a1;
      box-shadow: 0 8px 16px rgba(255, 179, 71, 0.16);
    }

    .pill em {
      font-style: normal;
      color: #0f0d1c;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border-radius: 22px;
      padding: 22px 20px;
      box-shadow: 0 18px 40px rgba(43, 36, 63, 0.16);
      position: relative;
      overflow: hidden;
      border: 2px solid #ffe0a1;
    }

    .card h2 {
      margin: 6px 0 8px;
      font-size: 22px;
      color: #ff5c99;
      text-shadow: 0 2px 0 #ffe6f4;
    }

    .card p {
      margin: 4px 0 12px;
      color: var(--muted);
    }

    .card::after {
      content: "";
      position: absolute;
      inset: -80px -120px auto auto;
      width: 260px;
      height: 260px;
      background: radial-gradient(circle, rgba(92, 198, 255, 0.35), transparent 50%);
      transform: rotate(12deg);
      z-index: 0;
    }

    .card>* {
      position: relative;
      z-index: 1;
    }

    form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    input[type="text"] {
      flex: 1;
      min-width: 180px;
      padding: 13px 15px;
      border-radius: 14px;
      border: 2px solid #ffd68a;
      font-size: 17px;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.1s;
      background: #fffdf7;
      box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.04);
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #ff7ac3;
      box-shadow: 0 0 0 4px rgba(255, 122, 195, 0.22);
      transform: translateY(-1px);
    }

    button {
      border: none;
      cursor: pointer;
      padding: 13px 18px;
      border-radius: 14px;
      font-weight: 800;
      font-size: 16px;
      transition: transform 0.12s, box-shadow 0.2s, background 0.2s;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #2b243f;
      box-shadow: 0 12px 26px rgba(255, 122, 195, 0.35);
      border: 2px solid #ffb7df;
    }

    button:hover {
      transform: translateY(-1px) scale(1.01);
    }

    button:active {
      transform: translateY(1px) scale(0.99);
    }

    button.secondary {
      background: linear-gradient(135deg, #d8f3ff, #fffdf7);
      color: #1d3045;
      border-color: #b9e8ff;
      box-shadow: 0 8px 20px rgba(92, 198, 255, 0.18);
    }

    .timer {
      margin: 6px 0 14px;
      font-weight: 800;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .timer-bar {
      width: 100%;
      height: 12px;
      background: #ffecc7;
      border-radius: 999px;
      overflow: hidden;
      position: relative;
      border: 2px solid #ffcf8a;
      box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .timer-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: repeating-linear-gradient(45deg, #ff7ac3, #ff7ac3 14px, #ffb347 14px, #ffb347 28px);
      transform-origin: left;
      transition: width 0.2s linear;
    }

    .feedback {
      margin-top: 14px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
    }

    .feedback.correct {
      color: var(--success);
    }

    .feedback.wrong {
      color: var(--danger);
    }

    .word-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fff3fd;
      border-radius: 999px;
      padding: 7px 12px;
      color: #b03286;
      font-weight: 800;
      font-size: 14px;
      border: 2px solid #ffd5f2;
      box-shadow: 0 6px 14px rgba(255, 122, 195, 0.2);
    }

    .stacked {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .scoreboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .scoreboard-item {
      background: linear-gradient(135deg, rgba(255, 186, 92, 0.15), rgba(92, 198, 255, 0.12));
      border: 2px solid #ffcf8a;
      border-radius: 16px;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      box-shadow: 0 10px 22px rgba(43, 36, 63, 0.12);
    }

    .scoreboard-item strong {
      color: var(--text);
    }

    .badge {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: linear-gradient(135deg, #66e3b0, #5cc6ff);
      display: grid;
      place-items: center;
      font-weight: 800;
      color: #0c1c2a;
      border: 2px solid #b5f3da;
      box-shadow: 0 6px 14px rgba(102, 227, 176, 0.22);
    }

    .muted {
      color: var(--muted);
      font-size: 14px;
    }

    .hidden {
      display: none !important;
    }

    .floating {
      position: absolute;
      opacity: 0.3;
      pointer-events: none;
      filter: blur(0.3px);
      animation: floaty 6s ease-in-out infinite;
    }

    .float-1 {
      width: 140px;
      height: 140px;
      background: #ffb347;
      top: -18px;
      right: -24px;
      border-radius: 32px;
      transform: rotate(10deg);
    }

    .float-2 {
      width: 110px;
      height: 110px;
      background: #5cc6ff;
      bottom: -16px;
      left: -10px;
      border-radius: 30px;
      transform: rotate(-6deg);
      animation-delay: 1.2s;
    }

    .float-3 {
      width: 120px;
      height: 120px;
      background: #ff7ac3;
      bottom: -30px;
      right: 16px;
      border-radius: 38px;
      transform: rotate(18deg);
      animation-delay: 0.6s;
    }

    .summary {
      margin-top: 12px;
      padding: 12px;
      border: 2px dashed #ffcf8a;
      border-radius: 14px;
      background: #fff8ed;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: inset 0 3px 8px rgba(255, 186, 92, 0.14);
    }

    .tip-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 12px;
      background: #e9f9ff;
      color: #195270;
      font-weight: 700;
    }

    .confetti-container {
      pointer-events: none;
      position: fixed;
      inset: 0;
      overflow: hidden;
      z-index: 999;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 16px;
      border-radius: 4px;
      opacity: 0.9;
      animation: confetti-fall var(--dur) ease-out forwards;
      transform-origin: center;
    }

    @keyframes confetti-fall {
      0% {
        transform: translate3d(var(--x), -12vh, 0) rotateZ(0deg) rotateX(0deg);
        opacity: 0;
      }

      15% {
        opacity: 1;
      }

      100% {
        transform: translate3d(calc(var(--x) + var(--drift)), 110vh, 0) rotateZ(720deg) rotateX(540deg);
        opacity: 0.9;
      }
    }

    @keyframes floaty {

      0%,
      100% {
        transform: translateY(0) rotate(6deg);
      }

      50% {
        transform: translateY(8px) rotate(-4deg);
      }
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }

      header {
        justify-content: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <h1><span>üêù</span> Spelling Quest</h1>
      <div class="meta">
        <div class="pill">Score: <em id="score">0</em> / 15</div>
        <div class="pill">Word: <em id="word-count">0</em> / 15</div>
        <div class="pill">Time: <em id="time-left">--</em>s</div>
      </div>
    </header>

    <div class="grid">
      <section class="card" id="setup-card">
        <div class="floating float-1"></div>
        <div class="floating float-2"></div>
        <h2>Ready to buzz?</h2>
        <p>Pick a player name, press start, listen for the word, and race the rainbow timer! Fifteen words per round.
        </p>
        <form id="setup-form">
          <input type="text" id="player-name" placeholder="Your first name" required maxlength="20"
            aria-label="Player name">
          <button type="submit">Start the buzz!</button>
        </form>
        <div class="summary">
          <div class="tag">‚ú® Adventure tips</div>
          <div class="muted">üêù Tap the speaker if you need to hear the word again.</div>
          <div class="muted">‚è∞ Timer is 30 to 50 seconds, based on the word length.</div>
          <div class="muted">üèÖ Finish all 15 words to save your score.</div>
        </div>
      </section>

      <section class="card stacked hidden" id="game-card">
        <div>
          <h2>Buzzing round</h2>
          <p class="muted">Listen, then type your best spelling before the timer pops!</p>
          <div class="timer">
            <span class="word-chip">‚è± <span id="timer-label">Ready</span></span>
            <div class="timer-bar">
              <div class="timer-fill" id="timer-fill"></div>
            </div>
          </div>
          <div class="muted" id="hint">Press the speaker to hear your word.</div>
        </div>

        <div>
          <div class="pill" style="display:inline-flex; align-items:center; gap:6px; margin-bottom:8px;">
            <button type="button" class="secondary" id="speak-btn" aria-label="Speak word">üîä Speak word</button>
            <span class="muted">Word <span id="current-word-number">1</span> of 15</span>
          </div>
          <form id="answer-form">
            <input type="text" id="answer-input" autocomplete="off" placeholder="Type the spelling here"
              aria-label="Your spelling">
            <button type="submit">Submit</button>
          </form>
          <div class="feedback" id="feedback" aria-live="polite"></div>
        </div>
      </section>

      <section class="card stacked hidden" id="summary-card">
        <div class="floating float-3"></div>
        <h2>Great job, superstar! üéâ</h2>
        <p class="muted">Nice work! Check the scoreboard to see your place.</p>
        <div class="summary">
          <div><strong>Final score</strong>: <span id="final-score">0</span> / 15</div>
          <div id="correct-count" class="muted"></div>
          <div id="miss-count" class="muted"></div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="play-again">Play again</button>
          <button id="review-btn" class="secondary">See missed words</button>
        </div>
        <div class="summary hidden" id="review-list"></div>
      </section>

      <section class="card stacked" id="scoreboard-card">
        <div class="floating float-2"></div>
        <h2>Hive scoreboard</h2>
        <p class="muted">Scores stick in your browser after each 15-word round.</p>
        <ul class="scoreboard-list" id="scoreboard"></ul>
        <div class="muted" id="no-scores">No scores yet. Finish a game to save one!</div>
      </section>
    </div>
  </div>

  <script>
    const TOTAL_WORDS = 15;
    const storageKey = "spelling-quest-scores";
    const words = [
      "garden", "puzzle", "mystery", "pillow", "rocket", "planet", "capture",
      "dolphin", "river", "thunder", "whistle", "shadow", "canyon", "pepper",
      "marble", "castle", "forest", "sunrise", "parade", "feather", "velvet", "bubble",
      "courage", "giraffe", "bicycle", "alphabet", "holiday", "friend", "giggle", "basket",
      "silver", "nature", "cousin", "explore", "adventure", "cactus", "sudden", "wonder",
      "pirate", "anchor", "jungle", "flavor", "winter", "summer", "autumn", "spring",
      "farmer", "brave", "memory", "island", "harbor", "blanket", "fortune", "lizard",
      "morning", "evening", "pocket", "lightning", "music", "treasure", "secret", "fossil",
      "lantern", "kindness", "harvest", "sparkle", "orchard", "sandwich", "cabin", "grateful",
      "library", "science", "pioneer", "picture", "energy", "rainbow",
      "unicorn", "pirates", "leaning", "acrobat", "forepaw", "recipe", "mermaid", "incredible", "nervous", "raise", "attacked", "streetlights", "shouting", "dinosaur",
      "gorgeous", "avocado", "formation", "faraway", "understand", "breakfast", "message", "elephant", "garbage", "bombarded", "leather", "peppercorn", "weather",
      "turnout", "journey", "asleep", "brilliant", "monsoon", "valentine", "especially", "heater", "wooden",
      "window", "chocolate", "hedgehog", "surprise", "disability", "countess", "cartwheel",
      "zooming", "eaten", "courtyard", "curious", "vacuum", "dangerous", "February"
    ];
    const uniqueWords = Array.from(new Set(words));

    const setupCard = document.getElementById("setup-card");
    const gameCard = document.getElementById("game-card");
    const summaryCard = document.getElementById("summary-card");
    const scoreboardList = document.getElementById("scoreboard");
    const noScoresEl = document.getElementById("no-scores");
    const reviewList = document.getElementById("review-list");
    const timerFill = document.getElementById("timer-fill");
    const timerLabel = document.getElementById("timer-label");
    let feedbackClearTimeout = null;
    let confettiContainer = null;

    const scoreEl = document.getElementById("score");
    const wordCountEl = document.getElementById("word-count");
    const timeLeftEl = document.getElementById("time-left");
    const currentWordNumberEl = document.getElementById("current-word-number");
    const feedbackEl = document.getElementById("feedback");
    const hintEl = document.getElementById("hint");
    const finalScoreEl = document.getElementById("final-score");
    const correctCountEl = document.getElementById("correct-count");
    const missCountEl = document.getElementById("miss-count");

    const setupForm = document.getElementById("setup-form");
    const answerForm = document.getElementById("answer-form");
    const nameInput = document.getElementById("player-name");
    const answerInput = document.getElementById("answer-input");
    const speakBtn = document.getElementById("speak-btn");
    const playAgainBtn = document.getElementById("play-again");
    const reviewBtn = document.getElementById("review-btn");

    let gameState = {
      name: "",
      score: 0,
      index: 0,
      remaining: [],
      currentWord: "",
      timerId: null,
      deadline: null,
      answered: false,
      misses: [],
      totalMs: 0,
      pausedMs: 0
    };

    const shuffle = (arr) => {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    };

    const clamp = (val, min, max) => Math.min(max, Math.max(min, val));

    function clearFeedbackLine() {
      if (feedbackClearTimeout) {
        clearTimeout(feedbackClearTimeout);
        feedbackClearTimeout = null;
      }
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
    }

    function scheduleFeedbackClear() {
      if (feedbackClearTimeout) clearTimeout(feedbackClearTimeout);
      feedbackClearTimeout = setTimeout(() => {
        clearFeedbackLine();
      }, 5000);
    }

    function ensureConfettiContainer() {
      if (confettiContainer) return confettiContainer;
      const div = document.createElement("div");
      div.className = "confetti-container";
      document.body.appendChild(div);
      confettiContainer = div;
      return div;
    }

    function launchConfetti() {
      const holder = ensureConfettiContainer();
      const colors = ["#ff7ac3", "#ffb347", "#5cc6ff", "#66e3b0", "#fff577"];
      const pieces = 120;
      holder.innerHTML = "";
      for (let i = 0; i < pieces; i++) {
        const piece = document.createElement("div");
        piece.className = "confetti-piece";
        piece.style.background = colors[Math.floor(Math.random() * colors.length)];
        piece.style.setProperty("--x", `${Math.random() * 100}vw`);
        piece.style.setProperty("--drift", `${(Math.random() * 120) - 60}px`);
        piece.style.setProperty("--dur", `${1.8 + Math.random() * 1.4}s`);
        piece.style.left = `${Math.random() * 100}%`;
        holder.appendChild(piece);
        setTimeout(() => piece.remove(), 3500);
      }
      setTimeout(() => {
        if (holder.childElementCount === 0) holder.innerHTML = "";
      }, 3800);
    }

    function nextWords() {
      const pool = uniqueWords.length >= TOTAL_WORDS ? uniqueWords : words;
      const shuffled = shuffle(pool);
      return shuffled.slice(0, TOTAL_WORDS);
    }

    function startGame(name) {
      gameState = {
        name,
        score: 0,
        index: 0,
        remaining: nextWords(),
        currentWord: "",
        timerId: null,
        deadline: null,
        answered: false,
        misses: []
      };
      scoreEl.textContent = "0";
      wordCountEl.textContent = "0";
      timeLeftEl.textContent = "--";
      currentWordNumberEl.textContent = "1";
      feedbackEl.textContent = "";
      clearFeedbackLine();
      reviewList.innerHTML = "";
      reviewList.classList.add("hidden");
      summaryCard.classList.add("hidden");
      setupCard.classList.add("hidden");
      gameCard.classList.remove("hidden");
      answerInput.value = "";
      answerInput.focus();
      loadNextWord();
    }

    function speak(word) {
      if (!window.speechSynthesis) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(word);
      u.lang = "en-US";
      u.rate = 0.7;  // original: 0.95
      u.pitch = 1.02; // original: 1.02
      window.speechSynthesis.speak(u);
    }

    function timeForWord(word) {
      const len = word.length;
      return clamp(20 + Math.round(len * 1.2), 30, 50);
    }

    function startTimer(seconds, resumeMs) {
      clearTimer();
      const totalMs = resumeMs ?? seconds * 1000;
      const now = Date.now();
      gameState.deadline = now + totalMs;
      gameState.totalMs = totalMs;
      gameState.pausedMs = 0;
      timerFill.style.width = "100%";
      const startingSeconds = Math.ceil(totalMs / 1000);
      timerLabel.textContent = `${startingSeconds}s left`;
      timeLeftEl.textContent = startingSeconds;
      gameState.timerId = setInterval(() => {
        const remainingMs = gameState.deadline - Date.now();
        gameState.pausedMs = remainingMs;
        const remaining = Math.max(0, Math.ceil(remainingMs / 1000));
        const pct = clamp(remainingMs / (gameState.totalMs || 1), 0, 1);
        timerFill.style.width = `${pct * 100}%`;
        timerLabel.textContent = `${remaining}s left`;
        timeLeftEl.textContent = remaining;
        if (remaining <= 0) {
          clearTimer();
          if (!gameState.answered) handleResult("", true);
        }
      }, 150);
    }

    function clearTimer() {
      if (gameState.timerId) {
        clearInterval(gameState.timerId);
        gameState.timerId = null;
      }
    }

    function loadNextWord() {
      if (gameState.index >= TOTAL_WORDS) {
        finishGame();
        return;
      }
      gameState.currentWord = gameState.remaining[gameState.index];
      gameState.answered = false;
      const seconds = timeForWord(gameState.currentWord);
      wordCountEl.textContent = gameState.index + 1;
      currentWordNumberEl.textContent = gameState.index + 1;
      hintEl.textContent = "Press the speaker to hear your word.";
      answerInput.value = "";
      answerInput.focus();
      speak(gameState.currentWord);
      startTimer(seconds);
    }

    function handleResult(guessRaw, timedOut = false) {
      gameState.answered = true;
      clearTimer();
      const guess = guessRaw.trim().toLowerCase();
      const correctSpelling = gameState.currentWord.toLowerCase();
      const correct = !timedOut && guess === correctSpelling;
      if (correct) {
        gameState.score += 1;
        feedbackEl.textContent = "Correct! üéØ";
        feedbackEl.className = "feedback correct";
      } else {
        const missReason = timedOut ? "‚è≥ Time's up!" : "‚úñÔ∏è Not quite.";
        feedbackEl.textContent = `${missReason} It was "${gameState.currentWord}".`;
        feedbackEl.className = "feedback wrong";
        gameState.misses.push({
          word: gameState.currentWord,
          typed: timedOut ? "(no answer)" : guessRaw || "(no answer)"
        });
      }
      scheduleFeedbackClear();
      scoreEl.textContent = gameState.score;
      wordCountEl.textContent = gameState.index + 1;
      timeLeftEl.textContent = "‚Äî";
      timerLabel.textContent = "Next word loading";
      timerFill.style.width = "0%";

      setTimeout(() => {
        gameState.index += 1;
        loadNextWord();
      }, 900);
    }

    function finishGame() {
      clearTimer();
      gameCard.classList.add("hidden");
      summaryCard.classList.remove("hidden");
      finalScoreEl.textContent = gameState.score;
      correctCountEl.textContent = `Words correct: ${gameState.score}`;
      missCountEl.textContent = `Words missed: ${TOTAL_WORDS - gameState.score}`;
      timeLeftEl.textContent = "‚Äî";
      wordCountEl.textContent = `${TOTAL_WORDS}`;
      scoreEl.textContent = gameState.score;
      saveScore({ name: gameState.name, score: gameState.score, date: new Date().toISOString() });
      renderScores();
      launchConfetti();
    }

    function saveScore(entry) {
      const list = loadScores();
      list.push(entry);
      list.sort((a, b) => b.score - a.score || new Date(b.date) - new Date(a.date));
      const trimmed = list.slice(0, 10);
      localStorage.setItem(storageKey, JSON.stringify(trimmed));
    }

    function loadScores() {
      try {
        const stored = localStorage.getItem(storageKey);
        if (!stored) return [];
        return JSON.parse(stored);
      } catch (e) {
        console.warn("Could not read scores", e);
        return [];
      }
    }

    function renderScores() {
      const entries = loadScores();
      scoreboardList.innerHTML = "";
      if (!entries.length) {
        noScoresEl.classList.remove("hidden");
        return;
      }
      noScoresEl.classList.add("hidden");
      entries.forEach((entry, idx) => {
        const li = document.createElement("li");
        li.className = "scoreboard-item";
        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = idx + 1;
        const label = document.createElement("div");
        label.innerHTML = `<strong>${entry.name || "Player"}</strong><div class="muted">${new Date(entry.date).toLocaleDateString()}</div>`;
        const score = document.createElement("div");
        score.innerHTML = `<strong>${entry.score}</strong> / ${TOTAL_WORDS}`;
        li.appendChild(badge);
        li.appendChild(label);
        li.appendChild(score);
        scoreboardList.appendChild(li);
      });
    }

    function showReview() {
      if (!gameState.misses.length) {
        reviewList.innerHTML = "<strong>Perfect round!</strong>";
      } else {
        reviewList.innerHTML = gameState.misses.map((m, idx) =>
          `<div>${idx + 1}. <strong>${m.word}</strong> ‚Äî you typed: <em>${m.typed}</em></div>`
        ).join("");
      }
      reviewList.classList.remove("hidden");
    }

    setupForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = nameInput.value.trim() || "Player";
      startGame(name);
    });

    answerForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (gameState.answered) return;
      const guess = answerInput.value;
      handleResult(guess, false);
    });

    speakBtn.addEventListener("click", () => {
      if (!gameState.currentWord) return;
      hintEl.textContent = "Listen closely‚Ä¶";
      speak(gameState.currentWord);
    });

    answerInput.addEventListener("input", () => {
      clearFeedbackLine();
    });

    playAgainBtn.addEventListener("click", () => {
      summaryCard.classList.add("hidden");
      setupCard.classList.remove("hidden");
      nameInput.focus();
    });

    reviewBtn.addEventListener("click", () => showReview());

    document.addEventListener("visibilitychange", () => {
      if (document.hidden && gameState.timerId) {
        const remainingMs = Math.max(0, gameState.deadline - Date.now());
        clearTimer();
        gameState.pausedMs = remainingMs;
        timerLabel.textContent = "Timer paused";
        hintEl.textContent = "We paused your timer while you were away.";
      } else if (!document.hidden && gameState.currentWord && !gameState.answered && gameState.pausedMs > 0) {
        startTimer(timeForWord(gameState.currentWord), gameState.pausedMs);
        hintEl.textContent = "Timer resumed. Keep spelling!";
      }
    });

    renderScores();
  </script>
</body>

</html>